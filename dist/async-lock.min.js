// angular-async-locks v0.3.0
// Copyright (c)2014 Boris Kozorovitzky.
// Distributed under MIT license
// https://github.com/BorisKozo/angular-async-locks

angular.module("boriskozo.async-locks",[]).factory("AsyncLockFactory",["$timeout",function(a){"use strict";function b(){return new Date-this.start}function c(){this.lock&&this.lock.leave(this)}var d=0,e=function(a){this.queue=[],this.ownerTokenId=null,this.options=angular.extend({},e.defaultOptions,a)};return e.defaultOptions={maxQueueSize:1/0,overflowStrategy:"this"},e.prototype.createToken=function(a){return{id:d++,isCanceled:!1,callback:a,elapsed:b,start:new Date,lock:this,leave:c}},e.prototype.reduceQueue=function(a,b){var c=[];if("number"!=typeof b.maxQueueSize||isNaN(b.maxQueueSize))return c;if(a.length>b.maxQueueSize){if("last"===b.overflowStrategy){for(var d=a.pop();a.length&&a.length>b.maxQueueSize-1;)c.unshift(a.pop());return a.push(d),c}if("first"===b.overflowStrategy){for(;a.length&&a.length>b.maxQueueSize;)c.push(a.shift());return c}if(a.length&&"this"===b.overflowStrategy)return c.push(a.pop()),c}return c},e.prototype.executeCallback=function(b){a(function(){b.callback(b)},0)},e.prototype.enter=function(a,b){if(!angular.isFunction(a))throw new Error("Callback must be a function");var c=this.createToken(a);if(null===c||void 0===c)throw new Error("Token cannot be null or undefined");if(null!==this.ownerTokenId){this.queue.push(c),b&&(c.timeoutId=setTimeout(function(){c.isCanceled=!0,c.timeoutId=null},b));var d,e=this.reduceQueue(this.queue,this.options);for(d=0;d<e.length;d++)e[d].isCanceled=!0,e[d].timeoutId&&clearTimeout(e[d].timeoutId)}else this.ownerTokenId=c.id,this.executeCallback(c);return c},e.prototype.leave=function(a,b){if(null===a||void 0===a)throw new Error("Token cannot be null or undefined");if(null===this.ownerTokenId)throw new Error("There is no pending token in the lock but received "+JSON.stringify(a));if(this.ownerTokenId!==a.id)throw new Error("Owner token mismatch. Expected "+this.ownerTokenId+" but received "+JSON.stringify(a.id));var c;for(this.ownerTokenId=null;this.queue.length>0;)if(c=this.queue.shift(),c.timeoutId&&clearTimeout(c.timeoutId),!c.isCanceled){if(b!==!0){this.ownerTokenId=c.id,this.executeCallback(c);break}c.isCanceled=!0}},e.prototype.isLocked=function(){return null!==this.ownerTokenId},e.prototype.queueSize=function(){return this.queue.length},e}]).factory("ResetEventFactory",[function(){"use strict";function a(){return new Date-this.start}var b=0,c=function(a,b){this.queue=[],this.isSignaled=Boolean(a),this.options=angular.extend({},c.defaultOptions,b)};return c.defaultOptions={maxQueueSize:1/0,overflowStrategy:"this",autoResetCount:1/0},c.prototype.createToken=function(c){return{id:b++,isCanceled:!1,callback:c,elapsed:a,start:new Date,resetEvent:this}},c.prototype.reduceQueue=function(a,b){var c=[];if("number"!=typeof b.maxQueueSize||isNaN(b.maxQueueSize))return c;if(a.length>b.maxQueueSize){if("last"===b.overflowStrategy){for(var d=a.pop();a.length&&a.length>b.maxQueueSize-1;)c.unshift(a.pop());return a.push(d),c}if("first"===b.overflowStrategy){for(;a.length&&a.length>b.maxQueueSize;)c.push(a.shift());return c}if(a.length&&"this"===b.overflowStrategy)return c.push(a.pop()),c}return c},c.prototype.executeCallback=function(a){a.callback(a)},c.prototype.reset=function(){if(this.isSignaled===!1)throw new Error("The reset event is already in a non signaled state");this.isSignaled=!1},c.prototype.set=function(){var a;if(this.isSignaled===!0)throw new Error("The reset event is already in a signaled state");for(this.callbacksCount=this.options.autoResetCount;this.queue.length>0;)if(a=this.queue.shift(),this.callbacksCount--,a.timeoutId&&this.callbacksCount>0&&clearTimeout(a.timeoutId),a.isCanceled)this.callbacksCount++;else if(this.executeCallback(a),0===this.callbacksCount)return;this.isSignaled=!0},c.prototype.wait=function(a,b){if(!angular.isFunction(a))throw new Error("Callback must be a function");var c=this.createToken(a);if(null===c||void 0===c)throw new Error("Token cannot be null or undefined");b&&(c.timeoutId=setTimeout(function(){c.isCanceled=!0,c.timeoutId=null},b)),this.isSignaled?(this.executeCallback(c),this.callbacksCount--,0===this.callbacksCount&&(this.isSignaled=!1)):this.queue.push(c);var d,e=this.reduceQueue(this.queue,this.options);for(d=0;d<e.length;d++)e[d].isCanceled=!0,e[d].timeoutId&&clearTimeout(e[d].timeoutId);return c},c.prototype.isSignaled=function(){return this.isSignaled},c.prototype.queueSize=function(){return this.queue.length},c}]).service("AsyncLockService",["AsyncLockFactory","$q",function(a,b){"use strict";var c={};this.lock=function(b,d,e){if(!b||"string"!=typeof b)throw new Error("The name must be a non empty string");if(!angular.isFunction(d))throw new Error("Callback must be a function");c[b]||(c[b]=new a);var f=c[b];f.enter(function(a){d(function(){f.leave(a)})},e)},this.lockPromise=function(d,e){if(!d||"string"!=typeof d)throw new Error("The name must be a non empty string");if(!angular.isFunction(e))throw new Error("Callback must be a function");c[d]||(c[d]=new a);var f=b.defer(),g=Array.prototype.slice.call(arguments,2),h=c[d];return h.enter(function(a){e.apply(null,g).then(function(b){f.resolve(b),h.leave(a)},function(b){f.reject(b),h.leave(a)},function(a){f.notify(a)})}),f.promise},this.lockExists=function(a){if(!a||"string"!=typeof a)throw new Error("The name must be a non empty string");return Boolean(c[a])},this.isLocked=function(a){return this.lockExists(a)?c[a].isLocked():null},this.queueSize=function(a){return this.lockExists(a)?c[a].queueSize():null},this.setOptions=function(b,d){this.lockExists(b)?c[b].options=angular.extend(c[b].options,d):c[b]=new a(d)},this.getOptions=function(a){return this.lockExists(a)?angular.copy(c[a].options):null}}]);